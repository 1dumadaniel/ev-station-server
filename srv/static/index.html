<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EV Station Control</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin-bottom:16px; }
    button { padding:10px 14px; border-radius:10px; border:0; margin-right:8px; }
    .start { background:#16a34a; color:#fff; }
    .stop { background:#dc2626; color:#fff; }
    input,select { padding:8px; border-radius:8px; border:1px solid #ccc; }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <h2>EV Station Control (MVP)</h2>

  <div class="card">
    <div class="row">
      <label>Server:</label>
      <input id="base" value="" placeholder="https://app.onrender.com" size="34">
      <label>Station ID:</label>
      <input id="sid" value="hotel-A" size="10">
      <button onclick="connectWS()">Conectează live</button>
    </div>
    <p id="live">–</p>
  </div>

  <div class="card">
    <div class="row">
      <button class="start" onclick="sendCmd('start')">Start</button>
      <button class="stop"  onclick="sendCmd('stop')">Stop</button>
      <label>Limit kW:</label><input id="limit" type="number" step="0.1" value="7.0" style="width:80px">
      <button onclick="getStatus()">Status</button>
    </div>
    <pre id="status"></pre>
  </div>

<script>
let ws=null, BASE="", SID="";

function connectWS(){
  BASE = document.getElementById('base').value.trim();
  SID  = document.getElementById('sid').value.trim();
  if(ws){ ws.close(); ws=null; }
  const url = BASE.replace(/^http/,'ws') + "/ws/station/" + encodeURIComponent(SID);
  ws = new WebSocket(url);
  ws.onopen = ()=> setLive("Conectat WebSocket.");
  ws.onclose= ()=> setLive("WS închis.");
  ws.onerror= e => setLive("Eroare WS.");
  ws.onmessage = ev => {
    const data = JSON.parse(ev.data);
    setStatus(data);
  };
}

function setLive(txt){ document.getElementById('live').innerText = txt; }
function setStatus(obj){ document.getElementById('status').innerText = JSON.stringify(obj,null,2); }

async function sendCmd(action){
  BASE = document.getElementById('base').value.trim();
  SID  = document.getElementById('sid').value.trim();
  const limit = parseFloat(document.getElementById('limit').value||"0");
  const r = await fetch(`${BASE}/station/${encodeURIComponent(SID)}/command`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, limit_kW: isNaN(limit)?null:limit})
  });
  setStatus(await r.json());
}

async function getStatus(){
  BASE = document.getElementById('base').value.trim();
  SID  = document.getElementById('sid').value.trim();
  const r = await fetch(`${BASE}/station/${encodeURIComponent(SID)}/status`);
  setStatus(await r.json());
}
</script>
</body>
</html>
